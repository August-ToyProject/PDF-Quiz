name: React App CI/CD

on:
  push:
    branches:
      - main
      - development  # development ë¸Œëœì¹˜ë¡œ ë³€ê²½
    paths:
        - 'FE/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        cd FE/pdf_quiz
        npm install

    - name: Build the React app
      run: |
        cd FE/pdf_quiz
        npm run build

    - name: Notify Slack on Failure ğŸ’€ (Build Step)
      if: failure()
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          CHANNEL="#your-channel-main"
          MESSAGE=":x: *ë¹Œë“œ ì‹¤íŒ¨!* :rotating_light: \n<@${{ env.SLACK_USER_1 }}> <@${{ env.SLACK_USER_2 }}>\n ë°°í¬ ê°œë³µì¹˜ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì´ê¸°ì§€ ëª»í•˜ê³  ë¹Œë“œ ë‹¨ê³„ì—ì„œ ë¬´ë„ˆì¡ŒìŠµë‹ˆë‹¤... :skull: :warning: ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‚´ë ¤ì£¼ì„¸ìš”! âš ï¸"
        else
          CHANNEL="#your-channel-development"
          MESSAGE=":x: *development ë¹Œë“œ ì‹¤íŒ¨!* :rotating_light: \n<@${{ env.SLACK_USER_1 }}> <@${{ env.SLACK_USER_2 }}>\n development í™˜ê²½ì—ì„œ ë¹Œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
        fi
        curl -X POST -H 'Content-type: application/json' --data "{
          \"channel\": \"$CHANNEL\",
          \"text\": \"$MESSAGE\",
          \"username\": \"DeployMola\",
          \"icon_emoji\": \":skull:\"
        }" ${{ secrets.SLACK_DEPLOY_WEB_HOOK }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEB_HOOK }}
      SLACK_USER_1: 'U07FB0CTK8V'
      SLACK_USER_2: 'U07F5U2HV1C'

    steps:
    - name: Check out code
      uses: actions/checkout@v4
      
    - name: Set EC2 host and user based on branch
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          export EC2_HOST=${{ secrets.EC2_REACT_HOST }}
          export EC2_USER=ubuntu
        else
          export EC2_HOST=${{ secrets.EC2_REACT_HOST_DEV }}
          export EC2_USER=root
        fi
        echo "Using EC2_HOST: $EC2_HOST"
        echo "Using EC2_USER: $EC2_USER"
      
    - name: Add SSH key to agent
      run: |
        echo "${{ secrets.EC2_SSH_REACT_KEY }}" | tr -d '\r' > key.pem  # Windowsì™€ Unix ì¤„ë°”ê¿ˆ ë¬¸ì œ í•´ê²°
        chmod 400 key.pem
        eval "$(ssh-agent -s)"
        ssh-add key.pem

    - name: Test SSH connection
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST "echo Connection successful"

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
          echo "Running run.sh on EC2"
          sh run.sh
          echo "Finished running run.sh"
        ENDSSH

    - name: Notify Slack on Success ğŸ‰
      if: success()
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          CHANNEL="#your-channel-main"
          MESSAGE=":white_check_mark: *ë°°í¬ ì„±ê³µ!* :tada: :rocket: \n<@${{ env.SLACK_USER_1 }}> <@${{ env.SLACK_USER_2 }}> ë°°í¬ ê°œë³µì¹˜ê°€ ì˜¤ëŠ˜ë„ ë¬´ì‚¬íˆ ë°°í¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ğŸ‰ ì˜¤ëŠ˜ì˜ ë°°í¬ëŠ” ì„±ê³µì ì…ë‹ˆë‹¤! ğŸŸ :rocket:"
        else
          CHANNEL="#your-channel-development"
          MESSAGE=":white_check_mark: *development ë°°í¬ ì„±ê³µ!* :tada: \n<@${{ env.SLACK_USER_1 }}> <@${{ env.SLACK_USER_2 }}> development í™˜ê²½ì—ì„œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! :rocket:"
        fi
        curl -X POST -H 'Content-type: application/json' --data "{
          \"channel\": \"$CHANNEL\",
          \"text\": \"$MESSAGE\",
          \"username\": \"DeployMola\",
          \"icon_emoji\": \":fish:\"
        }" ${{ secrets.SLACK_DEPLOY_WEB_HOOK }}

    - name: Notify Slack on Failure ğŸ’€
      if: failure()
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          CHANNEL="#your-channel-main"
          MESSAGE=":x: *ë°°í¬ ì‹¤íŒ¨!* :rotating_light: \n<@${{ env.SLACK_USER_1 }}> <@${{ env.SLACK_USER_2 }}>\n ë°°í¬ ê°œë³µì¹˜ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì´ê¸°ì§€ ëª»í•˜ê³  ê¾€ê¼¬ë‹¥í–ˆìŠµë‹ˆë‹¤... :skull: :warning: ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‚´ë ¤ì£¼ì„¸ìš”! âš ï¸"
        else
          CHANNEL="#your-channel-development"
          MESSAGE=":x: *development ë°°í¬ ì‹¤íŒ¨!* :rotating_light: \n<@${{ env.SLACK_USER_1 }}> <@${{ env.SLACK_USER_2 }}>\n development í™˜ê²½ì—ì„œ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
        fi
        curl -X POST -H 'Content-type: application/json' --data "{
          \"channel\": \"$CHANNEL\",
          \"text\": \"$MESSAGE\",
          \"username\": \"DeployMola\",
          \"icon_emoji\": \":skull:\"
        }" ${{ secrets.SLACK_DEPLOY_WEB_HOOK }}
