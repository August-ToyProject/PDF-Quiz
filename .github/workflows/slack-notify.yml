name: Slack Notification on PR and Merge

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]]; then
              TEXT=":rotating_light: *PRì´ ë©”ì¸ ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!*\n\nğŸ“‚ *ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\nğŸ‘¤ *ë¨¸ì§€í•œ ì‚¬ëŒ:* ${{ github.actor }}\nğŸ”— <${{ github.event.compare }}|*ë³€ê²½ ë‚´ìš© ë³´ê¸°*>\n\n:arrow_down: ëª¨ë‘ ìµœì‹  ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë©”ì¸ ë¸Œëœì¹˜ë¥¼ í’€ í•˜ì„¸ìš”!"
            else
              TEXT=":rocket: *ìƒˆë¡œìš´ ì»¤ë°‹ì´ ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!*\n\nğŸ“‚ *ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\nğŸ‘¤ *ì‘ì„±ì:* ${{ github.actor }}\nğŸ“ *ì»¤ë°‹ ë©”ì‹œì§€:* ${{ github.event.head_commit.message }}\nğŸ”— <${{ github.event.head_commit.url }}|*ì»¤ë°‹ ë³´ê¸°*>\nğŸ” <${{ github.event.compare }}|*ë³€ê²½ ë‚´ìš© ë³´ê¸°*>\n\n:arrow_down: ëª¨ë‘ ìµœì‹  ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë©”ì¸ ë¸Œëœì¹˜ë¥¼ í’€ í•˜ì„¸ìš”!"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TEXT=":sparkles: *í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ${{ github.event.pull_request.state }} ë˜ì—ˆìŠµë‹ˆë‹¤!*\n\nğŸ“ *ì œëª©:* ${{ github.event.pull_request.title }}\nğŸ‘¤ *ì‘ì„±ì:* ${{ github.event.pull_request.user.login }}\nğŸ“‚ *ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\nğŸ”— <${{ github.event.pull_request.html_url }}|*PR ë³´ê¸°*>"
          else
            TEXT=":warning: ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event_name }}"
          fi

          # íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          TEXT=$(echo "$TEXT" | sed 's/"/\\"/g')

          PAYLOAD="{\"text\": \"$TEXT\"}"

          echo "Sending payload to Slack:"
          echo "$PAYLOAD"

          RESPONSE=$(curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" -w "\n%{http_code}")
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Slack API Response:"
          echo "Status Code: $HTTP_STATUS"
          echo "Body: $BODY"

          if [[ "$HTTP_STATUS" != "200" ]]; then
            echo "Error: Failed to send message to Slack"
            exit 1
          fi
