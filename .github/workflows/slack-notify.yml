name: Slack Notification on PR and Merge

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send notification to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # GitHub ì´ë²¤íŠ¸ ë°ì´í„°ë¥¼ JSON í˜•íƒœë¡œ ë°›ì•„ì˜µë‹ˆë‹¤
          EVENT_DATA=$(jq '.' <<< '${{ toJson(github.event) }}')
          
          # ë©”ì‹œì§€ë¥¼ ì´ë²¤íŠ¸ì— ë”°ë¼ ì„¤ì •í•©ë‹ˆë‹¤.
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¤ë°‹ ìˆ˜ ê³„ì‚°
            COMMIT_COUNT=$(echo "$EVENT_DATA" | jq '.commits | length')

            # PR ë¨¸ì§€ ì»¤ë°‹ì¸ì§€ í™•ì¸
            if [[ "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]]; then
              MESSAGE=":rotating_light: *PRì´ ë©”ì¸ ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!*\n\n*ğŸ“‚ ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\n*ğŸ‘¤ ë¨¸ì§€í•œ ì‚¬ëŒ:* ${{ github.actor }}\n*ğŸ”— [ë³€ê²½ ë‚´ìš© ë³´ê¸°](${{ github.event.compare }})\n\nëª¨ë‘ ìµœì‹  ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë©”ì¸ ë¸Œëœì¹˜ë¥¼ í’€ í•˜ì„¸ìš”! :arrow_down:"
            else
              MESSAGE=":rocket: *ìƒˆë¡œìš´ ì»¤ë°‹ì´ ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!*\n\n*ğŸ“‚ ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\n*ğŸ‘¤ ì‘ì„±ì:* ${{ github.actor }}\n*ğŸ”¢ ì»¤ë°‹ ìˆ˜:* ${COMMIT_COUNT}\n*ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€:* ${{ github.event.head_commit.message }}\n*ğŸ”— [ì»¤ë°‹ ë³´ê¸°](${{ github.event.head_commit.url }})\n*ğŸ” [ë³€ê²½ ë‚´ìš© ë³´ê¸°](${{ github.event.compare }})"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_USER="${{ github.event.pull_request.user.login }}"
            PR_STATE="${{ github.event.pull_request.state }}"
            # í•„ìš”í•œ ì •ë³´ë§Œ ì¶”ì¶œí•˜ì—¬ ë©”ì‹œì§€ êµ¬ì„±
            MESSAGE=":sparkles: *í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ${PR_STATE} ë˜ì—ˆìŠµë‹ˆë‹¤!*\n\n*ğŸ“„ ì œëª©:* ${PR_TITLE}\n*ğŸ‘¤ ì‘ì„±ì:* ${PR_USER}\n*ğŸ“‚ ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\n*ğŸ”— [PR ë³´ê¸°](${PR_URL})"
          else
            MESSAGE=":warning: ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event_name }}"
          fi

          # Slackìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          PAYLOAD=$(jq -n --arg text "$MESSAGE" '{text: $text}')
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
