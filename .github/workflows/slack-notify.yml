name: Slack Notification on PR and Merge
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened]
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          EVENT_DATA=$(jq '.' <<< '${{ toJson(github.event) }}')
          
          if [[ "${{ github.event_name }}" == "push" ]]; then
            COMMIT_COUNT=$(echo "$EVENT_DATA" | jq '.commits | length')
            if [[ "${{ github.event.head_commit.message }}" == *"Merge pull request"* ]]; then
              TITLE=":rotating_light: PRì´ ë©”ì¸ ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
              CONTENT="*ğŸ“‚ ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\n*ğŸ‘¤ ë¨¸ì§€í•œ ì‚¬ëŒ:* ${{ github.actor }}\n*ğŸ”— <${{ github.event.compare }}|ë³€ê²½ ë‚´ìš© ë³´ê¸°>\n\nëª¨ë‘ ìµœì‹  ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë©”ì¸ ë¸Œëœì¹˜ë¥¼ í’€ í•˜ì„¸ìš”! :arrow_down:"
            else
              TITLE=":rocket: ìƒˆë¡œìš´ ì»¤ë°‹ì´ ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"
              CONTENT="*ğŸ“‚ ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\n*ğŸ‘¤ ì‘ì„±ì:* ${{ github.actor }}\n*ğŸ”¢ ì»¤ë°‹ ìˆ˜:* ${COMMIT_COUNT}\n*ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€:* ${{ github.event.head_commit.message }}\n*ğŸ”— <${{ github.event.head_commit.url }}|ì»¤ë°‹ ë³´ê¸°>\n*ğŸ” <${{ github.event.compare }}|ë³€ê²½ ë‚´ìš© ë³´ê¸°>"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TITLE=":sparkles: í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ${{ github.event.pull_request.state }} ë˜ì—ˆìŠµë‹ˆë‹¤!"
            CONTENT="*ğŸ“„ ì œëª©:* ${{ github.event.pull_request.title }}\n*ğŸ‘¤ ì‘ì„±ì:* ${{ github.event.pull_request.user.login }}\n*ğŸ“‚ ë ˆí¬ì§€í† ë¦¬:* ${{ github.repository }}\n*ğŸ”— <${{ github.event.pull_request.html_url }}|PR ë³´ê¸°>"
          else
            TITLE=":warning: ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event_name }}"
            CONTENT=""
          fi

          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg content "$CONTENT" \
            '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": $title,
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": $content
                  }
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
