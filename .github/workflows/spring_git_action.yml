name: Spring Boot CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'BE/spring/**'
  pull_request:
    branches:
      - main
    paths:
      - 'BE/spring/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_SPRING_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      SSH_KEY: ${{ secrets.EC2_SSH_SPRING_KEY }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEB_HOOK }}  # SLACK_DEPLOY_WEB_HOOK ì‹œí¬ë¦¿ ì‚¬ìš©
      SLACK_USER_ID: 'U07F90W5TKN'  # ìŠ¬ë™ ì‚¬ìš©ì ID í•˜ë“œì½”ë”©

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v2
      with:
        java-version: '21'

    - name: Build with Gradle
      run: ./gradlew build

    - name: SCP to EC2
      run: |
        scp -o StrictHostKeyChecking=no -i ${{ secrets.SSH_KEY }} build/libs/quiz-application-0.0.1-SNAPSHOT.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/quiz-application-0.0.1-SNAPSHOT.jar

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.SSH_KEY }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          # ê¸°ì¡´ ìŠ¤í”„ë§ ì„œë²„ ì¢…ë£Œ
          ps -ef | grep java | grep -v grep | awk '{print $2}' | xargs kill -9 || true
          
          # ìƒˆë¡œìš´ JAR íŒŒì¼ ì‹¤í–‰
          nohup java -Duser.timezone=Asia/Seoul -jar /home/ubuntu/quiz-application-0.0.1-SNAPSHOT.jar > /dev/null 2>&1 &
          echo "Application has been successfully deployed!"
        EOF

    - name: Notify Slack on Success ğŸ‰
      if: success()  # ë°°í¬ ì„±ê³µ ì‹œ
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "channel": "#your-channel",
          "text": "<@${{ env.SLACK_USER_ID }}> ê°œë³µì¹˜ê°€ ì˜¤ëŠ˜ë„ ë¬´ì‚¬íˆ ë°°í¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ğŸ‰ ì˜¤ëŠ˜ì€ ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì§€ ì•Šê³  ì˜ ë²„í…¼ë„¤ìš”! ğŸŸ",
          "username": "DeployMola",
          "icon_emoji": ":fish:"
        }' ${{ env.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on Failure ğŸ’€
      if: failure()  # ë°°í¬ ì‹¤íŒ¨ ì‹œ
      run: |
        BUILD_LOG=$(tail -n 10 $GITHUB_WORKSPACE/build/libs/quiz-application-0.0.1-SNAPSHOT.jar.log)
        curl -X POST -H 'Content-type: application/json' --data '{
          "channel": "#your-channel",
          "text": "<@${{ env.SLACK_USER_ID }}> ê°œë³µì¹˜ê°€ ë°°í¬ ì¤‘ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ì„œ... ì£½ì—ˆìŠµë‹ˆë‹¤... ğŸ’€ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‚´ë ¤ì£¼ì„¸ìš”!\n\n```\n'"$BUILD_LOG"'\n```",
          "username": "DeployMola",
          "icon_emoji": ":skull:"
        }' ${{ env.SLACK_WEBHOOK_URL }}
