# name: Spring Boot CI/CD

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'BE/spring/**'
#   pull_request:
#     branches:
#       - main
#     paths:
#       - 'BE/spring/**'

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     env:
#       EC2_HOST: ${{ secrets.EC2_SPRING_HOST }}
#       EC2_USER: ${{ secrets.EC2_USER }}
#       SSH_KEY: ${{ secrets.EC2_SSH_SPRING_KEY }}
#       SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEB_HOOK }}
#       SLACK_USER_ID: 'U07F90W5TKN'

#     steps:
#     - name: Check out code
#       uses: actions/checkout@v4

#     - name: Set up JDK 21
#       uses: actions/setup-java@v2
#       with:
#         java-version: '21'
#         distribution: 'temurin'
#         java-package: 'jdk'

#     - name: Build with Gradle (Skip Tests)
#       run: |
#         cd BE/spring/quiz-application
#         ./gradlew build -x test  # ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ìƒëµ)

#     - name: Check build output
#       run: |
#         pwd
#         cd BE/spring/quiz-application
#         ls -al ./build/libs  # ë¹Œë“œ ê²°ê³¼ í™•ì¸

#     - name: Compress JAR file
#       run: |
#         cd BE/spring/quiz-application/build/libs
#         gzip -c quiz-application-0.0.1-SNAPSHOT.jar > quiz-application-0.0.1-SNAPSHOT.jar.gz
#         ls -al  # ì••ì¶•ëœ íŒŒì¼ í™•ì¸

#     - name: Add SSH key to agent
#       run: |
#         echo "$SSH_KEY" | tr -d '\r' > key.pem
#         chmod 400 key.pem
#         eval "$(ssh-agent -s)"
#         ssh-add key.pem

#     - name: Test SSH connection
#       run: |
#         ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST "echo Connection successful"

#     - name: SCP compressed JAR to EC2
#       run: |
#         scp -o StrictHostKeyChecking=no -i key.pem BE/spring/quiz-application/build/libs/quiz-application-0.0.1-SNAPSHOT.jar.gz $EC2_USER@$EC2_HOST:/home/ubuntu/quiz-application-0.0.1-SNAPSHOT.jar.gz

#     - name: Deploy to EC2
#       run: |
#         ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST << 'EOF'
#           # ê¸°ì¡´ ìŠ¤í”„ë§ ì„œë²„ ì¢…ë£Œ
#           ps -ef | grep java | grep -v grep | awk '{print $2}' | xargs kill -9 || true

#           # ì••ì¶• í•´ì œ
#           gunzip /home/ubuntu/quiz-application-0.0.1-SNAPSHOT.jar.gz

#           # ìƒˆë¡œìš´ JAR íŒŒì¼ ì‹¤í–‰
#           nohup java -Duser.timezone=Asia/Seoul -jar /home/ubuntu/quiz-application-0.0.1-SNAPSHOT.jar > /dev/null 2>&1 &
#           echo "Application has been successfully deployed!"
#         EOF

#     - name: Notify Slack on Success ğŸ‰
#       if: success()
#       run: |
#         curl -X POST -H 'Content-type: application/json' --data '{
#           "channel": "#your-channel",
#           "text": ":white_check_mark: *ë°°í¬ ì„±ê³µ!* :tada: :rocket: \n<@${{ env.SLACK_USER_ID }}> ë°°í¬ ê°œë³µì¹˜ê°€ ì˜¤ëŠ˜ë„ ë¬´ì‚¬íˆ ë°°í¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ğŸ‰ ì˜¤ëŠ˜ì˜ ë°°í¬ëŠ” ì„±ê³µì ì…ë‹ˆë‹¤! ğŸŸ :rocket:",
#           "username": "DeployMola",
#           "icon_emoji": ":fish:"
#         }' ${{ env.SLACK_WEBHOOK_URL }}

#     - name: Notify Slack on Failure ğŸ’€
#       if: failure()
#       run: |
#         curl -X POST -H 'Content-type: application/json' --data '{
#           "channel": "#your-channel",
#           "text": ":x: *ë°°í¬ ì‹¤íŒ¨!* :rotating_light: \n<@${{ env.SLACK_USER_ID }}>\n ë°°í¬ ê°œë³µì¹˜ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì´ê¸°ì§€ ëª»í•˜ê³  ê¾€ê¼¬ë‹¥í–ˆìŠµë‹ˆë‹¤... :skull: :warning: ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‚´ë ¤ì£¼ì„¸ìš”! âš ï¸",
#           "username": "DeployMola",
#           "icon_emoji": ":skull:"
#         }' ${{ env.SLACK_WEBHOOK_URL }}
